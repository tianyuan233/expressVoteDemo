extends ../base.pug

//- block style
//-   style.
//-     li {
//-       list-style:none;
//-     }

block content
  h1 标题: #{vote.title}
  h2 描述: #{vote.desc}
  hr
  ul(data-voteid=vote.id)#option-list
    each option in options
      li(data-optionid=option.id) 
        h3(data-optionid=option.id) #{option.content}
        span

  if username
      h2.user #{info}  
  script.
    let optionList = document.querySelector('#option-list')
    let voteId = optionList.dataset.voteid

    function updateState(voteResult) {
      var counted = _.countBy(voteResult, 'optionid')
      console.log(counted)
      _.forEach(counted, (val, key) => {
        document.querySelector(`[data-optionid="${key}"]`).lastChild.textContent = val +'票'
      })
    }

    async function main() {
      var voteResult = (await axios.get(`/vote/info/${optionList.dataset.voteid}`)).data

      if (voteResult == null) {
        voteResult = []
      }

      //- var socket = io()

      //- socket.on('new vote', data => {
      //-   voteResult.push(data)
      //-   updateState(voteResult)
      //- })

      updateState(voteResult)
    }

    main()


    optionList.addEventListener('click', async e => {
      let optionid = e.target.dataset.optionid
      let voteResult = (await axios.post(`/vote/${voteId}`, 
        {
          voteid: optionList.dataset.voteid,
          optionid: optionid,
        }
        )).data
        updateState(voteResult)
    })